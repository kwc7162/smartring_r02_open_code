<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.7.0"/>
    <title>colmi_r02_client.db API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../colmi_r02_client.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;colmi_r02_client</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#logger">logger</a>
            </li>
            <li>
                    <a class="class" href="#Base">Base</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Base.__init__">Base</a>
                        </li>
                        <li>
                                <a class="variable" href="#Base.registry">registry</a>
                        </li>
                        <li>
                                <a class="variable" href="#Base.metadata">metadata</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#DateTimeInUTC">DateTimeInUTC</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#DateTimeInUTC.impl">impl</a>
                        </li>
                        <li>
                                <a class="variable" href="#DateTimeInUTC.cache_ok">cache_ok</a>
                        </li>
                        <li>
                                <a class="function" href="#DateTimeInUTC.process_bind_param">process_bind_param</a>
                        </li>
                        <li>
                                <a class="function" href="#DateTimeInUTC.process_result_value">process_result_value</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Ring">Ring</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Ring.__init__">Ring</a>
                        </li>
                        <li>
                                <a class="variable" href="#Ring.ring_id">ring_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#Ring.address">address</a>
                        </li>
                        <li>
                                <a class="variable" href="#Ring.heart_rates">heart_rates</a>
                        </li>
                        <li>
                                <a class="variable" href="#Ring.syncs">syncs</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Sync">Sync</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Sync.__init__">Sync</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sync.sync_id">sync_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sync.ring_id">ring_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sync.timestamp">timestamp</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sync.comment">comment</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sync.ring">ring</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sync.heart_rates">heart_rates</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#HeartRate">HeartRate</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#HeartRate.__init__">HeartRate</a>
                        </li>
                        <li>
                                <a class="variable" href="#HeartRate.heart_rate_id">heart_rate_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#HeartRate.reading">reading</a>
                        </li>
                        <li>
                                <a class="variable" href="#HeartRate.timestamp">timestamp</a>
                        </li>
                        <li>
                                <a class="variable" href="#HeartRate.ring_id">ring_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#HeartRate.ring">ring</a>
                        </li>
                        <li>
                                <a class="variable" href="#HeartRate.sync_id">sync_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#HeartRate.sync">sync</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#set_sqlite_pragma">set_sqlite_pragma</a>
            </li>
            <li>
                    <a class="function" href="#get_db_session">get_db_session</a>
            </li>
            <li>
                    <a class="function" href="#create_or_find_ring">create_or_find_ring</a>
            </li>
            <li>
                    <a class="function" href="#sync">sync</a>
            </li>
            <li>
                    <a class="function" href="#get_last_sync">get_last_sync</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../colmi_r02_client.html">colmi_r02_client</a><wbr>.db    </h1>

                
                        <input id="mod-db-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-db-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span> <span class="nn">logging</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span><span class="p">,</span> <span class="n">Mapped</span><span class="p">,</span> <span class="n">mapped_column</span><span class="p">,</span> <span class="n">Session</span><span class="p">,</span> <span class="n">relationship</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">UniqueConstraint</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">types</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="kn">import</span> <span class="n">Engine</span><span class="p">,</span> <span class="n">Dialect</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span> <span class="nn">colmi_r02_client</span> <span class="kn">import</span> <span class="n">hr</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span> <span class="nn">colmi_r02_client.client</span> <span class="kn">import</span> <span class="n">FullData</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span> <span class="nn">colmi_r02_client.date_utils</span> <span class="kn">import</span> <span class="n">start_of_day</span><span class="p">,</span> <span class="n">end_of_day</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>    <span class="k">pass</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="k">class</span> <span class="nc">DateTimeInUTC</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">TypeDecorator</span><span class="p">):</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">    TypeDecorator for sqlalchemy that will:</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">        1. make sure that you cannot save datetimes with no tzinfo/timezone</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">        2. convert any datetime to utc before saving it</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">        3. add the utc timezone to all datetimes retrieved from the database</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>    <span class="n">impl</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">DateTime</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>    <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to store </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> that&#39;s not a datetime&quot;</span><span class="p">)</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to store </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> with no timezone&quot;</span><span class="p">)</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>    <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to add timezone to </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> that&#39;s not a datetime&quot;</span><span class="p">)</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="k">class</span> <span class="nc">Ring</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;rings&quot;</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span><span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">),)</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>    <span class="n">ring_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>    <span class="n">address</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>    <span class="n">heart_rates</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;ring&quot;</span><span class="p">)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>    <span class="n">syncs</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Sync&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;ring&quot;</span><span class="p">)</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="k">class</span> <span class="nc">Sync</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;syncs&quot;</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>    <span class="n">sync_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>    <span class="n">ring_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;rings.ring_id&quot;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">DateTimeInUTC</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>    <span class="n">comment</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>    <span class="n">ring</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="s2">&quot;Ring&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;syncs&quot;</span><span class="p">)</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>    <span class="n">heart_rates</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;sync&quot;</span><span class="p">)</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="k">class</span> <span class="nc">HeartRate</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;heart_rates&quot;</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span><span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;ring_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">),)</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>    <span class="n">heart_rate_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>    <span class="n">reading</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">DateTimeInUTC</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>    <span class="n">ring_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;rings.ring_id&quot;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>    <span class="n">ring</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="s2">&quot;Ring&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;heart_rates&quot;</span><span class="p">)</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>    <span class="n">sync_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;syncs.sync_id&quot;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>    <span class="n">sync</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="s2">&quot;Sync&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;heart_rates&quot;</span><span class="p">)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Engine</span><span class="p">,</span> <span class="s2">&quot;connect&quot;</span><span class="p">)</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="k">def</span> <span class="nf">set_sqlite_pragma</span><span class="p">(</span><span class="n">dbapi_connection</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">_connection_record</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Enable actual foreign key checks in sqlite on every connection to the database&quot;&quot;&quot;</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="n">dbapi_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys=ON&quot;</span><span class="p">)</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="k">def</span> <span class="nf">get_db_session</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Session</span><span class="p">:</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">    Return a live db session with all tables created.</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">    TODO: probably not default to in memory... that&#39;s just useful for testing</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;sqlite:///&quot;</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using in memory sqlite database. Data will be lost after program exits&quot;</span><span class="p">)</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;:memory:&quot;</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>    <span class="k">return</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="k">def</span> <span class="nf">create_or_find_ring</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Ring</span><span class="p">:</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>    <span class="n">ring</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">Ring</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Ring</span><span class="o">.</span><span class="n">address</span> <span class="o">==</span> <span class="n">address</span><span class="p">))</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>    <span class="k">if</span> <span class="n">ring</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>        <span class="k">return</span> <span class="n">ring</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>    <span class="n">ring</span> <span class="o">=</span> <span class="n">Ring</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">)</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># not sure this should be here tbh</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>    <span class="k">return</span> <span class="n">ring</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">FullData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">    TODO:</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">        - grab battery</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="sd">        - grab steps</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>    <span class="n">ring</span> <span class="o">=</span> <span class="n">create_or_find_ring</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>    <span class="n">sync</span> <span class="o">=</span> <span class="n">Sync</span><span class="p">(</span><span class="n">ring</span><span class="o">=</span><span class="n">ring</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">))</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sync</span><span class="p">)</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>    <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">heart_rates</span><span class="p">:</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">hr</span><span class="o">.</span><span class="n">NoData</span><span class="p">):</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No heart rate data for date&quot;</span><span class="p">)</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>            <span class="k">continue</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>        <span class="n">existing</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>        <span class="k">for</span> <span class="n">heart_rate</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>            <span class="n">select</span><span class="p">(</span><span class="n">HeartRate</span><span class="p">)</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">HeartRate</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;=</span> <span class="n">start_of_day</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">timestamp</span><span class="p">))</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">HeartRate</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&lt;=</span> <span class="n">end_of_day</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">timestamp</span><span class="p">))</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="p">):</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>            <span class="n">existing</span><span class="p">[</span><span class="n">heart_rate</span><span class="o">.</span><span class="n">timestamp</span><span class="p">]</span> <span class="o">=</span> <span class="n">heart_rate</span><span class="o">.</span><span class="n">reading</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="k">for</span> <span class="n">reading</span><span class="p">,</span> <span class="n">timestamp</span> <span class="ow">in</span> <span class="n">log</span><span class="o">.</span><span class="n">heart_rates_with_times</span><span class="p">():</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>            <span class="k">if</span> <span class="n">reading</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>                <span class="k">continue</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>            <span class="k">if</span> <span class="n">x</span> <span class="o">:=</span> <span class="n">existing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>                <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">reading</span><span class="p">:</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inconsistent data detected! </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> in db but got </span><span class="si">{</span><span class="n">reading</span><span class="si">}</span><span class="s2"> from ring&quot;</span><span class="p">)</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>                <span class="n">h</span> <span class="o">=</span> <span class="n">HeartRate</span><span class="p">(</span><span class="n">reading</span><span class="o">=</span><span class="n">reading</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">ring</span><span class="o">=</span><span class="n">ring</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="n">sync</span><span class="p">)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="k">def</span> <span class="nf">get_last_sync</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>    <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Sync</span><span class="o">.</span><span class="n">timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>
</span></pre></div>


            </section>
                <section id="logger">
                    <div class="attr variable">
            <span class="name">logger</span>        =
<span class="default_value">&lt;Logger <a href="">colmi_r02_client.db</a> (WARNING)&gt;</span>

        
    </div>
    <a class="headerlink" href="#logger"></a>
    
    

                </section>
                <section id="Base">
                            <input id="Base-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Base</span><wbr>(<span class="base">sqlalchemy.inspection.Inspectable[sqlalchemy.orm.state.InstanceState[typing.Any]]</span>):

                <label class="view-source-button" for="Base-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Base"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Base-18"><a href="#Base-18"><span class="linenos">18</span></a><span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
</span><span id="Base-19"><a href="#Base-19"><span class="linenos">19</span></a>    <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Base class used for declarative class definitions.</p>

<p>The <code>_orm.DeclarativeBase</code> allows for the creation of new
declarative bases in such a way that is compatible with type checkers::</p>

<pre><code>from sqlalchemy.orm import DeclarativeBase

class Base(DeclarativeBase):
    pass
</code></pre>

<p>The above <code><a href="#Base">Base</a></code> class is now usable as the base for new declarative
mappings.  The superclass makes use of the <code>__init_subclass__()</code>
method to set up new classes and metaclasses aren't used.</p>

<p>When first used, the <code>_orm.DeclarativeBase</code> class instantiates a new
<code>_orm.registry</code> to be used with the base, assuming one was not
provided explicitly. The <code>_orm.DeclarativeBase</code> class supports
class-level attributes which act as parameters for the construction of this
registry; such as to indicate a specific <code>_schema.MetaData</code>
collection as well as a specific value for
:paramref:<code>_orm.registry.type_annotation_map</code>::</p>

<pre><code>from typing_extensions import Annotated

from sqlalchemy import BigInteger
from sqlalchemy import MetaData
from sqlalchemy import String
from sqlalchemy.orm import DeclarativeBase

bigint = Annotated[int, "bigint"]
my_metadata = MetaData()

class Base(DeclarativeBase):
    metadata = my_metadata
    type_annotation_map = {
        str: String().with_variant(String(255), "mysql", "mariadb"),
        bigint: BigInteger()
    }
</code></pre>

<p>Class-level attributes which may be specified include:</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>metadata</strong>:  optional <code>_schema.MetaData</code> collection.
If a <code>_orm.registry</code> is constructed automatically, this
<code>_schema.MetaData</code> collection will be used to construct it.
Otherwise, the local <code>_schema.MetaData</code> collection will supercede
that used by an existing <code>_orm.registry</code> passed using the
:paramref:<code>_orm.DeclarativeBase.registry</code> parameter.</li>
<li><strong>type_annotation_map</strong>:  optional type annotation map that will be
passed to the <code>_orm.registry</code> as
:paramref:<code>_orm.registry.type_annotation_map</code>.</li>
<li><strong>registry</strong>:  supply a pre-existing <code>_orm.registry</code> directly.</li>
</ul>

<p><em>New in version 2.0  Added <code>.DeclarativeBase</code>, so that declarative:</em>
base classes may be constructed in such a way that is also recognized
by :pep:<code>484</code> type checkers.   As a result, <code>.DeclarativeBase</code>
and other subclassing-oriented APIs should be seen as
superseding previous "class returned by a function" APIs, namely
<code>_orm.declarative_base()</code> and <code>_orm.registry.generate_base()</code>,
where the base class returned cannot be recognized by type checkers
without using plugins.</p>

<p><strong>__init__ behavior</strong></p>

<p>In a plain Python class, the base-most <code><a href="#Base.__init__">__init__()</a></code> method in the class
hierarchy is <code>object.__init__()</code>, which accepts no arguments. However,
when the <code>_orm.DeclarativeBase</code> subclass is first declared, the
class is given an <code><a href="#Base.__init__">__init__()</a></code> method that links to the
:paramref:<code>_orm.registry.constructor</code> constructor function, if no
<code><a href="#Base.__init__">__init__()</a></code> method is already present; this is the usual declarative
constructor that will assign keyword arguments as attributes on the
instance, assuming those attributes are established at the class level
(i.e. are mapped, or are linked to a descriptor). This constructor is
<strong>never accessed by a mapped class without being called explicitly via
super()</strong>, as mapped classes are themselves given an <code><a href="#Base.__init__">__init__()</a></code> method
directly which calls :paramref:<code>_orm.registry.constructor</code>, so in the
default case works independently of what the base-most <code><a href="#Base.__init__">__init__()</a></code>
method does.</p>

<p><em>Changed in version 2.0.1  <code>_orm.DeclarativeBase</code> has a default:</em>
constructor that links to :paramref:<code>_orm.registry.constructor</code> by
default, so that calls to <code>super().__init__()</code> can access this
constructor. Previously, due to an implementation mistake, this default
constructor was missing, and calling <code>super().__init__()</code> would invoke
<code>object.__init__()</code>.</p>

<p>The <code>_orm.DeclarativeBase</code> subclass may also declare an explicit
<code><a href="#Base.__init__">__init__()</a></code> method which will replace the use of the
:paramref:<code>_orm.registry.constructor</code> function at this level::</p>

<pre><code>class Base(DeclarativeBase):
    def __init__(self, id=None):
        self.id = id
</code></pre>

<p>Mapped classes still will not invoke this constructor implicitly; it
remains only accessible by calling <code>super().__init__()</code>::</p>

<pre><code>class MyClass(Base):
    def __init__(self, id=None, name=None):
        self.name = name
        super().__init__(id=id)
</code></pre>

<p>Note that this is a different behavior from what functions like the legacy
<code>_orm.declarative_base()</code> would do; the base created by those functions
would always install :paramref:<code>_orm.registry.constructor</code> for
<code><a href="#Base.__init__">__init__()</a></code>.</p>
</div>


                            <div id="Base.__init__" class="classattr">
                                        <input id="Base.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Base</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span></span>)</span>

                <label class="view-source-button" for="Base.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Base.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Base.__init__-2165"><a href="#Base.__init__-2165"><span class="linenos">2165</span></a><span class="k">def</span> <span class="nf">_declarative_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Base.__init__-2166"><a href="#Base.__init__-2166"><span class="linenos">2166</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A simple constructor that allows initialization from kwargs.</span>
</span><span id="Base.__init__-2167"><a href="#Base.__init__-2167"><span class="linenos">2167</span></a>
</span><span id="Base.__init__-2168"><a href="#Base.__init__-2168"><span class="linenos">2168</span></a><span class="sd">    Sets attributes on the constructed instance using the names and</span>
</span><span id="Base.__init__-2169"><a href="#Base.__init__-2169"><span class="linenos">2169</span></a><span class="sd">    values in ``kwargs``.</span>
</span><span id="Base.__init__-2170"><a href="#Base.__init__-2170"><span class="linenos">2170</span></a>
</span><span id="Base.__init__-2171"><a href="#Base.__init__-2171"><span class="linenos">2171</span></a><span class="sd">    Only keys that are present as</span>
</span><span id="Base.__init__-2172"><a href="#Base.__init__-2172"><span class="linenos">2172</span></a><span class="sd">    attributes of the instance&#39;s class are allowed. These could be,</span>
</span><span id="Base.__init__-2173"><a href="#Base.__init__-2173"><span class="linenos">2173</span></a><span class="sd">    for example, any mapped columns or relationships.</span>
</span><span id="Base.__init__-2174"><a href="#Base.__init__-2174"><span class="linenos">2174</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Base.__init__-2175"><a href="#Base.__init__-2175"><span class="linenos">2175</span></a>    <span class="n">cls_</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Base.__init__-2176"><a href="#Base.__init__-2176"><span class="linenos">2176</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="Base.__init__-2177"><a href="#Base.__init__-2177"><span class="linenos">2177</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls_</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
</span><span id="Base.__init__-2178"><a href="#Base.__init__-2178"><span class="linenos">2178</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="Base.__init__-2179"><a href="#Base.__init__-2179"><span class="linenos">2179</span></a>                <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> is an invalid keyword argument for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">cls_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="Base.__init__-2180"><a href="#Base.__init__-2180"><span class="linenos">2180</span></a>            <span class="p">)</span>
</span><span id="Base.__init__-2181"><a href="#Base.__init__-2181"><span class="linenos">2181</span></a>        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>A simple constructor that allows initialization from kwargs.</p>

<p>Sets attributes on the constructed instance using the names and
values in <code>kwargs</code>.</p>

<p>Only keys that are present as
attributes of the instance's class are allowed. These could be,
for example, any mapped columns or relationships.</p>
</div>


                            </div>
                            <div id="Base.registry" class="classattr">
                                <div class="attr variable">
            <span class="name">registry</span>        =
<span class="default_value">&lt;sqlalchemy.orm.decl_api.registry object&gt;</span>

        
    </div>
    <a class="headerlink" href="#Base.registry"></a>
    
    

                            </div>
                            <div id="Base.metadata" class="classattr">
                                <div class="attr variable">
            <span class="name">metadata</span>        =
<span class="default_value">MetaData()</span>

        
    </div>
    <a class="headerlink" href="#Base.metadata"></a>
    
    

                            </div>
                </section>
                <section id="DateTimeInUTC">
                            <input id="DateTimeInUTC-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">DateTimeInUTC</span><wbr>(<span class="base">sqlalchemy.sql.visitors.Visitable</span>, <span class="base">typing.Generic[~_T]</span>):

                <label class="view-source-button" for="DateTimeInUTC-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DateTimeInUTC"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DateTimeInUTC-22"><a href="#DateTimeInUTC-22"><span class="linenos">22</span></a><span class="k">class</span> <span class="nc">DateTimeInUTC</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">TypeDecorator</span><span class="p">):</span>
</span><span id="DateTimeInUTC-23"><a href="#DateTimeInUTC-23"><span class="linenos">23</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DateTimeInUTC-24"><a href="#DateTimeInUTC-24"><span class="linenos">24</span></a><span class="sd">    TypeDecorator for sqlalchemy that will:</span>
</span><span id="DateTimeInUTC-25"><a href="#DateTimeInUTC-25"><span class="linenos">25</span></a>
</span><span id="DateTimeInUTC-26"><a href="#DateTimeInUTC-26"><span class="linenos">26</span></a><span class="sd">        1. make sure that you cannot save datetimes with no tzinfo/timezone</span>
</span><span id="DateTimeInUTC-27"><a href="#DateTimeInUTC-27"><span class="linenos">27</span></a><span class="sd">        2. convert any datetime to utc before saving it</span>
</span><span id="DateTimeInUTC-28"><a href="#DateTimeInUTC-28"><span class="linenos">28</span></a><span class="sd">        3. add the utc timezone to all datetimes retrieved from the database</span>
</span><span id="DateTimeInUTC-29"><a href="#DateTimeInUTC-29"><span class="linenos">29</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="DateTimeInUTC-30"><a href="#DateTimeInUTC-30"><span class="linenos">30</span></a>
</span><span id="DateTimeInUTC-31"><a href="#DateTimeInUTC-31"><span class="linenos">31</span></a>    <span class="n">impl</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">DateTime</span>
</span><span id="DateTimeInUTC-32"><a href="#DateTimeInUTC-32"><span class="linenos">32</span></a>    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DateTimeInUTC-33"><a href="#DateTimeInUTC-33"><span class="linenos">33</span></a>
</span><span id="DateTimeInUTC-34"><a href="#DateTimeInUTC-34"><span class="linenos">34</span></a>    <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DateTimeInUTC-35"><a href="#DateTimeInUTC-35"><span class="linenos">35</span></a>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DateTimeInUTC-36"><a href="#DateTimeInUTC-36"><span class="linenos">36</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="DateTimeInUTC-37"><a href="#DateTimeInUTC-37"><span class="linenos">37</span></a>
</span><span id="DateTimeInUTC-38"><a href="#DateTimeInUTC-38"><span class="linenos">38</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
</span><span id="DateTimeInUTC-39"><a href="#DateTimeInUTC-39"><span class="linenos">39</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to store </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> that&#39;s not a datetime&quot;</span><span class="p">)</span>
</span><span id="DateTimeInUTC-40"><a href="#DateTimeInUTC-40"><span class="linenos">40</span></a>
</span><span id="DateTimeInUTC-41"><a href="#DateTimeInUTC-41"><span class="linenos">41</span></a>        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DateTimeInUTC-42"><a href="#DateTimeInUTC-42"><span class="linenos">42</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to store </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> with no timezone&quot;</span><span class="p">)</span>
</span><span id="DateTimeInUTC-43"><a href="#DateTimeInUTC-43"><span class="linenos">43</span></a>
</span><span id="DateTimeInUTC-44"><a href="#DateTimeInUTC-44"><span class="linenos">44</span></a>        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</span><span id="DateTimeInUTC-45"><a href="#DateTimeInUTC-45"><span class="linenos">45</span></a>
</span><span id="DateTimeInUTC-46"><a href="#DateTimeInUTC-46"><span class="linenos">46</span></a>    <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DateTimeInUTC-47"><a href="#DateTimeInUTC-47"><span class="linenos">47</span></a>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DateTimeInUTC-48"><a href="#DateTimeInUTC-48"><span class="linenos">48</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="DateTimeInUTC-49"><a href="#DateTimeInUTC-49"><span class="linenos">49</span></a>
</span><span id="DateTimeInUTC-50"><a href="#DateTimeInUTC-50"><span class="linenos">50</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
</span><span id="DateTimeInUTC-51"><a href="#DateTimeInUTC-51"><span class="linenos">51</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to add timezone to </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> that&#39;s not a datetime&quot;</span><span class="p">)</span>
</span><span id="DateTimeInUTC-52"><a href="#DateTimeInUTC-52"><span class="linenos">52</span></a>
</span><span id="DateTimeInUTC-53"><a href="#DateTimeInUTC-53"><span class="linenos">53</span></a>        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DateTimeInUTC-54"><a href="#DateTimeInUTC-54"><span class="linenos">54</span></a>            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</span><span id="DateTimeInUTC-55"><a href="#DateTimeInUTC-55"><span class="linenos">55</span></a>
</span><span id="DateTimeInUTC-56"><a href="#DateTimeInUTC-56"><span class="linenos">56</span></a>        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>TypeDecorator for sqlalchemy that will:</p>

<pre><code>1. make sure that you cannot save datetimes with no tzinfo/timezone
2. convert any datetime to utc before saving it
3. add the utc timezone to all datetimes retrieved from the database
</code></pre>
</div>


                            <div id="DateTimeInUTC.impl" class="classattr">
                                <div class="attr variable">
            <span class="name">impl</span>        =
<span class="default_value">&lt;class &#39;sqlalchemy.sql.sqltypes.DateTime&#39;&gt;</span>

        
    </div>
    <a class="headerlink" href="#DateTimeInUTC.impl"></a>
    
    

                            </div>
                            <div id="DateTimeInUTC.cache_ok" class="classattr">
                                <div class="attr variable">
            <span class="name">cache_ok</span>        =
<span class="default_value">True</span>

        
    </div>
    <a class="headerlink" href="#DateTimeInUTC.cache_ok"></a>
    
            <div class="docstring"><p>Indicate if statements using this <code>.ExternalType</code> are "safe to
cache".</p>

<p>The default value <code>None</code> will emit a warning and then not allow caching
of a statement which includes this type.   Set to <code>False</code> to disable
statements using this type from being cached at all without a warning.
When set to <code>True</code>, the object's class and selected elements from its
state will be used as part of the cache key.  For example, using a
<code>.TypeDecorator</code>::</p>

<pre><code>class MyType(TypeDecorator):
    impl = String

    cache_ok = True

    def __init__(self, choices):
        self.choices = tuple(choices)
        self.internal_only = True
</code></pre>

<p>The cache key for the above type would be equivalent to::</p>

<pre><code>&gt;&gt;&gt; MyType(["a", "b", "c"])._static_cache_key
(&lt;class '__main__.MyType'&gt;, ('choices', ('a', 'b', 'c')))
</code></pre>

<p>The caching scheme will extract attributes from the type that correspond
to the names of parameters in the <code><a href="#DateTimeInUTC.__init__">__init__()</a></code> method.  Above, the
"choices" attribute becomes part of the cache key but "internal_only"
does not, because there is no parameter named "internal_only".</p>

<p>The requirements for cacheable elements is that they are hashable
and also that they indicate the same SQL rendered for expressions using
this type every time for a given cache value.</p>

<p>To accommodate for datatypes that refer to unhashable structures such
as dictionaries, sets and lists, these objects can be made "cacheable"
by assigning hashable structures to the attributes whose names
correspond with the names of the arguments.  For example, a datatype
which accepts a dictionary of lookup values may publish this as a sorted
series of tuples.   Given a previously un-cacheable type as::</p>

<pre><code>class LookupType(UserDefinedType):
    '''a custom type that accepts a dictionary as a parameter.

    this is the non-cacheable version, as "self.lookup" is not
    hashable.

    '''

    def __init__(self, lookup):
        self.lookup = lookup

    def get_col_spec(self, **kw):
        return "VARCHAR(255)"

    def bind_processor(self, dialect):
        # ...  works with "self.lookup" ...
</code></pre>

<p>Where "lookup" is a dictionary.  The type will not be able to generate
a cache key::</p>

<pre><code>&gt;&gt;&gt; type_ = LookupType({"a": 10, "b": 20})
&gt;&gt;&gt; type_._static_cache_key
&lt;stdin&gt;:1: SAWarning: UserDefinedType LookupType({'a': 10, 'b': 20}) will not
produce a cache key because the ``cache_ok`` flag is not set to True.
Set this flag to True if this type object's state is safe to use
in a cache key, or False to disable this warning.
symbol('no_cache')
</code></pre>

<p>If we <strong>did</strong> set up such a cache key, it wouldn't be usable. We would
get a tuple structure that contains a dictionary inside of it, which
cannot itself be used as a key in a "cache dictionary" such as SQLAlchemy's
statement cache, since Python dictionaries aren't hashable::</p>

<pre><code>&gt;&gt;&gt; # set cache_ok = True
&gt;&gt;&gt; type_.cache_ok = True

&gt;&gt;&gt; # this is the cache key it would generate
&gt;&gt;&gt; key = type_._static_cache_key
&gt;&gt;&gt; key
(&lt;class '__main__.LookupType'&gt;, ('lookup', {'a': 10, 'b': 20}))

&gt;&gt;&gt; # however this key is not hashable, will fail when used with
&gt;&gt;&gt; # SQLAlchemy statement cache
&gt;&gt;&gt; some_cache = {key: "some sql value"}
Traceback (most recent call last): File "&lt;stdin&gt;", line 1,
in &lt;module&gt; TypeError: unhashable type: 'dict'
</code></pre>

<p>The type may be made cacheable by assigning a sorted tuple of tuples
to the ".lookup" attribute::</p>

<pre><code>class LookupType(UserDefinedType):
    '''a custom type that accepts a dictionary as a parameter.

    The dictionary is stored both as itself in a private variable,
    and published in a public variable as a sorted tuple of tuples,
    which is hashable and will also return the same value for any
    two equivalent dictionaries.  Note it assumes the keys and
    values of the dictionary are themselves hashable.

    '''

    cache_ok = True

    def __init__(self, lookup):
        self._lookup = lookup

        # assume keys/values of "lookup" are hashable; otherwise
        # they would also need to be converted in some way here
        self.lookup = tuple(
            (key, lookup[key]) for key in sorted(lookup)
        )

    def get_col_spec(self, **kw):
        return "VARCHAR(255)"

    def bind_processor(self, dialect):
        # ...  works with "self._lookup" ...
</code></pre>

<p>Where above, the cache key for <code>LookupType({"a": 10, "b": 20})</code> will be::</p>

<pre><code>&gt;&gt;&gt; LookupType({"a": 10, "b": 20})._static_cache_key
(&lt;class '__main__.LookupType'&gt;, ('lookup', (('a', 10), ('b', 20))))
</code></pre>

<p><em>New in version 1.4.14 - added the <code><a href="#DateTimeInUTC.cache_ok">cache_ok</a></code> flag to allow:</em>
some configurability of caching for <code>.TypeDecorator</code> classes.</p>

<p><em>New in version 1.4.28 - added the <code>.ExternalType</code> mixin which:</em>
generalizes the <code><a href="#DateTimeInUTC.cache_ok">cache_ok</a></code> flag to both the <code>.TypeDecorator</code>
and <code>.UserDefinedType</code> classes.</p>

<p><em>seealso.</em></p>
</div>


                            </div>
                            <div id="DateTimeInUTC.process_bind_param" class="classattr">
                                        <input id="DateTimeInUTC.process_bind_param-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">process_bind_param</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">value</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">_dialect</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">Dialect</span></span><span class="return-annotation">) -> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="DateTimeInUTC.process_bind_param-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DateTimeInUTC.process_bind_param"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DateTimeInUTC.process_bind_param-34"><a href="#DateTimeInUTC.process_bind_param-34"><span class="linenos">34</span></a>    <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DateTimeInUTC.process_bind_param-35"><a href="#DateTimeInUTC.process_bind_param-35"><span class="linenos">35</span></a>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DateTimeInUTC.process_bind_param-36"><a href="#DateTimeInUTC.process_bind_param-36"><span class="linenos">36</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="DateTimeInUTC.process_bind_param-37"><a href="#DateTimeInUTC.process_bind_param-37"><span class="linenos">37</span></a>
</span><span id="DateTimeInUTC.process_bind_param-38"><a href="#DateTimeInUTC.process_bind_param-38"><span class="linenos">38</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
</span><span id="DateTimeInUTC.process_bind_param-39"><a href="#DateTimeInUTC.process_bind_param-39"><span class="linenos">39</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to store </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> that&#39;s not a datetime&quot;</span><span class="p">)</span>
</span><span id="DateTimeInUTC.process_bind_param-40"><a href="#DateTimeInUTC.process_bind_param-40"><span class="linenos">40</span></a>
</span><span id="DateTimeInUTC.process_bind_param-41"><a href="#DateTimeInUTC.process_bind_param-41"><span class="linenos">41</span></a>        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DateTimeInUTC.process_bind_param-42"><a href="#DateTimeInUTC.process_bind_param-42"><span class="linenos">42</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to store </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> with no timezone&quot;</span><span class="p">)</span>
</span><span id="DateTimeInUTC.process_bind_param-43"><a href="#DateTimeInUTC.process_bind_param-43"><span class="linenos">43</span></a>
</span><span id="DateTimeInUTC.process_bind_param-44"><a href="#DateTimeInUTC.process_bind_param-44"><span class="linenos">44</span></a>        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Receive a bound parameter value to be converted.</p>

<p>Custom subclasses of <code>_types.TypeDecorator</code> should override
this method to provide custom behaviors for incoming data values.
This method is called at <strong>statement execution time</strong> and is passed
the literal Python data value which is to be associated with a bound
parameter in the statement.</p>

<p>The operation could be anything desired to perform custom
behavior, such as transforming or serializing data.
This could also be used as a hook for validating logic.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>value</strong>:  Data to operate upon, of any type expected by
this method in the subclass.  Can be <code>None</code>.</li>
<li><strong>dialect</strong>:  the <code>.Dialect</code> in use.</li>
</ul>

<p><em>seealso.</em></p>
</div>


                            </div>
                            <div id="DateTimeInUTC.process_result_value" class="classattr">
                                        <input id="DateTimeInUTC.process_result_value-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">process_result_value</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">value</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">_dialect</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">Dialect</span></span><span class="return-annotation">) -> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="DateTimeInUTC.process_result_value-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DateTimeInUTC.process_result_value"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DateTimeInUTC.process_result_value-46"><a href="#DateTimeInUTC.process_result_value-46"><span class="linenos">46</span></a>    <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DateTimeInUTC.process_result_value-47"><a href="#DateTimeInUTC.process_result_value-47"><span class="linenos">47</span></a>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DateTimeInUTC.process_result_value-48"><a href="#DateTimeInUTC.process_result_value-48"><span class="linenos">48</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="DateTimeInUTC.process_result_value-49"><a href="#DateTimeInUTC.process_result_value-49"><span class="linenos">49</span></a>
</span><span id="DateTimeInUTC.process_result_value-50"><a href="#DateTimeInUTC.process_result_value-50"><span class="linenos">50</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
</span><span id="DateTimeInUTC.process_result_value-51"><a href="#DateTimeInUTC.process_result_value-51"><span class="linenos">51</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to add timezone to </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> that&#39;s not a datetime&quot;</span><span class="p">)</span>
</span><span id="DateTimeInUTC.process_result_value-52"><a href="#DateTimeInUTC.process_result_value-52"><span class="linenos">52</span></a>
</span><span id="DateTimeInUTC.process_result_value-53"><a href="#DateTimeInUTC.process_result_value-53"><span class="linenos">53</span></a>        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DateTimeInUTC.process_result_value-54"><a href="#DateTimeInUTC.process_result_value-54"><span class="linenos">54</span></a>            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</span><span id="DateTimeInUTC.process_result_value-55"><a href="#DateTimeInUTC.process_result_value-55"><span class="linenos">55</span></a>
</span><span id="DateTimeInUTC.process_result_value-56"><a href="#DateTimeInUTC.process_result_value-56"><span class="linenos">56</span></a>        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Receive a result-row column value to be converted.</p>

<p>Custom subclasses of <code>_types.TypeDecorator</code> should override
this method to provide custom behaviors for data values
being received in result rows coming from the database.
This method is called at <strong>result fetching time</strong> and is passed
the literal Python data value that's extracted from a database result
row.</p>

<p>The operation could be anything desired to perform custom
behavior, such as transforming or deserializing data.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>value</strong>:  Data to operate upon, of any type expected by
this method in the subclass.  Can be <code>None</code>.</li>
<li><strong>dialect</strong>:  the <code>.Dialect</code> in use.</li>
</ul>

<p><em>seealso.</em></p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>sqlalchemy.sql.type_api.TypeDecorator</dt>
                                <dd id="DateTimeInUTC.__init__" class="function">TypeDecorator</dd>
                <dd id="DateTimeInUTC.impl_instance" class="function">impl_instance</dd>
                <dd id="DateTimeInUTC.coerce_to_is_types" class="variable">coerce_to_is_types</dd>
                <dd id="DateTimeInUTC.Comparator" class="class">Comparator</dd>
                <dd id="DateTimeInUTC.comparator_factory" class="variable">comparator_factory</dd>
                <dd id="DateTimeInUTC.type_engine" class="function">type_engine</dd>
                <dd id="DateTimeInUTC.load_dialect_impl" class="function">load_dialect_impl</dd>
                <dd id="DateTimeInUTC.process_literal_param" class="function">process_literal_param</dd>
                <dd id="DateTimeInUTC.literal_processor" class="function">literal_processor</dd>
                <dd id="DateTimeInUTC.bind_processor" class="function">bind_processor</dd>
                <dd id="DateTimeInUTC.result_processor" class="function">result_processor</dd>
                <dd id="DateTimeInUTC.bind_expression" class="function">bind_expression</dd>
                <dd id="DateTimeInUTC.column_expression" class="function">column_expression</dd>
                <dd id="DateTimeInUTC.coerce_compared_value" class="function">coerce_compared_value</dd>
                <dd id="DateTimeInUTC.copy" class="function">copy</dd>
                <dd id="DateTimeInUTC.get_dbapi_type" class="function">get_dbapi_type</dd>
                <dd id="DateTimeInUTC.compare_values" class="function">compare_values</dd>
                <dd id="DateTimeInUTC.sort_key_function" class="variable">sort_key_function</dd>

            </div>
            <div><dt>sqlalchemy.sql.base.SchemaEventTarget</dt>
                                <dd id="DateTimeInUTC.dispatch" class="function">dispatch</dd>

            </div>
            <div><dt>sqlalchemy.sql.type_api.TypeEngine</dt>
                                <dd id="DateTimeInUTC.render_bind_cast" class="variable">render_bind_cast</dd>
                <dd id="DateTimeInUTC.render_literal_cast" class="variable">render_literal_cast</dd>
                <dd id="DateTimeInUTC.hashable" class="variable">hashable</dd>
                <dd id="DateTimeInUTC.should_evaluate_none" class="variable">should_evaluate_none</dd>
                <dd id="DateTimeInUTC.evaluates_none" class="function">evaluates_none</dd>
                <dd id="DateTimeInUTC.copy_value" class="function">copy_value</dd>
                <dd id="DateTimeInUTC.python_type" class="variable">python_type</dd>
                <dd id="DateTimeInUTC.with_variant" class="function">with_variant</dd>
                <dd id="DateTimeInUTC.as_generic" class="function">as_generic</dd>
                <dd id="DateTimeInUTC.dialect_impl" class="function">dialect_impl</dd>
                <dd id="DateTimeInUTC.adapt" class="function">adapt</dd>
                <dd id="DateTimeInUTC.compile" class="function">compile</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Ring">
                            <input id="Ring-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Ring</span><wbr>(<span class="base">sqlalchemy.inspection.Inspectable[sqlalchemy.orm.state.InstanceState[typing.Any]]</span>):

                <label class="view-source-button" for="Ring-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Ring"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Ring-59"><a href="#Ring-59"><span class="linenos">59</span></a><span class="k">class</span> <span class="nc">Ring</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
</span><span id="Ring-60"><a href="#Ring-60"><span class="linenos">60</span></a>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;rings&quot;</span>
</span><span id="Ring-61"><a href="#Ring-61"><span class="linenos">61</span></a>    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span><span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">),)</span>
</span><span id="Ring-62"><a href="#Ring-62"><span class="linenos">62</span></a>    <span class="n">ring_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Ring-63"><a href="#Ring-63"><span class="linenos">63</span></a>    <span class="n">address</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="Ring-64"><a href="#Ring-64"><span class="linenos">64</span></a>    <span class="n">heart_rates</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;ring&quot;</span><span class="p">)</span>
</span><span id="Ring-65"><a href="#Ring-65"><span class="linenos">65</span></a>    <span class="n">syncs</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Sync&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;ring&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Base class used for declarative class definitions.</p>

<p>The <code>_orm.DeclarativeBase</code> allows for the creation of new
declarative bases in such a way that is compatible with type checkers::</p>

<pre><code>from sqlalchemy.orm import DeclarativeBase

class Base(DeclarativeBase):
    pass
</code></pre>

<p>The above <code><a href="#Base">Base</a></code> class is now usable as the base for new declarative
mappings.  The superclass makes use of the <code>__init_subclass__()</code>
method to set up new classes and metaclasses aren't used.</p>

<p>When first used, the <code>_orm.DeclarativeBase</code> class instantiates a new
<code>_orm.registry</code> to be used with the base, assuming one was not
provided explicitly. The <code>_orm.DeclarativeBase</code> class supports
class-level attributes which act as parameters for the construction of this
registry; such as to indicate a specific <code>_schema.MetaData</code>
collection as well as a specific value for
:paramref:<code>_orm.registry.type_annotation_map</code>::</p>

<pre><code>from typing_extensions import Annotated

from sqlalchemy import BigInteger
from sqlalchemy import MetaData
from sqlalchemy import String
from sqlalchemy.orm import DeclarativeBase

bigint = Annotated[int, "bigint"]
my_metadata = MetaData()

class Base(DeclarativeBase):
    metadata = my_metadata
    type_annotation_map = {
        str: String().with_variant(String(255), "mysql", "mariadb"),
        bigint: BigInteger()
    }
</code></pre>

<p>Class-level attributes which may be specified include:</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>metadata</strong>:  optional <code>_schema.MetaData</code> collection.
If a <code>_orm.registry</code> is constructed automatically, this
<code>_schema.MetaData</code> collection will be used to construct it.
Otherwise, the local <code>_schema.MetaData</code> collection will supercede
that used by an existing <code>_orm.registry</code> passed using the
:paramref:<code>_orm.DeclarativeBase.registry</code> parameter.</li>
<li><strong>type_annotation_map</strong>:  optional type annotation map that will be
passed to the <code>_orm.registry</code> as
:paramref:<code>_orm.registry.type_annotation_map</code>.</li>
<li><strong>registry</strong>:  supply a pre-existing <code>_orm.registry</code> directly.</li>
</ul>

<p><em>New in version 2.0  Added <code>.DeclarativeBase</code>, so that declarative:</em>
base classes may be constructed in such a way that is also recognized
by :pep:<code>484</code> type checkers.   As a result, <code>.DeclarativeBase</code>
and other subclassing-oriented APIs should be seen as
superseding previous "class returned by a function" APIs, namely
<code>_orm.declarative_base()</code> and <code>_orm.registry.generate_base()</code>,
where the base class returned cannot be recognized by type checkers
without using plugins.</p>

<p><strong>__init__ behavior</strong></p>

<p>In a plain Python class, the base-most <code><a href="#Ring.__init__">__init__()</a></code> method in the class
hierarchy is <code>object.__init__()</code>, which accepts no arguments. However,
when the <code>_orm.DeclarativeBase</code> subclass is first declared, the
class is given an <code><a href="#Ring.__init__">__init__()</a></code> method that links to the
:paramref:<code>_orm.registry.constructor</code> constructor function, if no
<code><a href="#Ring.__init__">__init__()</a></code> method is already present; this is the usual declarative
constructor that will assign keyword arguments as attributes on the
instance, assuming those attributes are established at the class level
(i.e. are mapped, or are linked to a descriptor). This constructor is
<strong>never accessed by a mapped class without being called explicitly via
super()</strong>, as mapped classes are themselves given an <code><a href="#Ring.__init__">__init__()</a></code> method
directly which calls :paramref:<code>_orm.registry.constructor</code>, so in the
default case works independently of what the base-most <code><a href="#Ring.__init__">__init__()</a></code>
method does.</p>

<p><em>Changed in version 2.0.1  <code>_orm.DeclarativeBase</code> has a default:</em>
constructor that links to :paramref:<code>_orm.registry.constructor</code> by
default, so that calls to <code>super().__init__()</code> can access this
constructor. Previously, due to an implementation mistake, this default
constructor was missing, and calling <code>super().__init__()</code> would invoke
<code>object.__init__()</code>.</p>

<p>The <code>_orm.DeclarativeBase</code> subclass may also declare an explicit
<code><a href="#Ring.__init__">__init__()</a></code> method which will replace the use of the
:paramref:<code>_orm.registry.constructor</code> function at this level::</p>

<pre><code>class Base(DeclarativeBase):
    def __init__(self, id=None):
        self.id = id
</code></pre>

<p>Mapped classes still will not invoke this constructor implicitly; it
remains only accessible by calling <code>super().__init__()</code>::</p>

<pre><code>class MyClass(Base):
    def __init__(self, id=None, name=None):
        self.name = name
        super().__init__(id=id)
</code></pre>

<p>Note that this is a different behavior from what functions like the legacy
<code>_orm.declarative_base()</code> would do; the base created by those functions
would always install :paramref:<code>_orm.registry.constructor</code> for
<code><a href="#Ring.__init__">__init__()</a></code>.</p>
</div>


                            <div id="Ring.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">Ring</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#Ring.__init__"></a>
    
            <div class="docstring"><p>A simple constructor that allows initialization from kwargs.</p>

<p>Sets attributes on the constructed instance using the names and
values in <code>kwargs</code>.</p>

<p>Only keys that are present as
attributes of the instance's class are allowed. These could be,
for example, any mapped columns or relationships.</p>
</div>


                            </div>
                            <div id="Ring.ring_id" class="classattr">
                                <div class="attr variable">
            <span class="name">ring_id</span><span class="annotation">: sqlalchemy.orm.base.Mapped[int]</span>

        
    </div>
    <a class="headerlink" href="#Ring.ring_id"></a>
    
    

                            </div>
                            <div id="Ring.address" class="classattr">
                                <div class="attr variable">
            <span class="name">address</span><span class="annotation">: sqlalchemy.orm.base.Mapped[str]</span>

        
    </div>
    <a class="headerlink" href="#Ring.address"></a>
    
    

                            </div>
                            <div id="Ring.heart_rates" class="classattr">
                                <div class="attr variable">
            <span class="name">heart_rates</span><span class="annotation">: sqlalchemy.orm.base.Mapped[list[<a href="#HeartRate">HeartRate</a>]]</span>

        
    </div>
    <a class="headerlink" href="#Ring.heart_rates"></a>
    
    

                            </div>
                            <div id="Ring.syncs" class="classattr">
                                <div class="attr variable">
            <span class="name">syncs</span><span class="annotation">: sqlalchemy.orm.base.Mapped[list[<a href="#Sync">Sync</a>]]</span>

        
    </div>
    <a class="headerlink" href="#Ring.syncs"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Base">Base</a></dt>
                                <dd id="Ring.registry" class="variable"><a href="#Base.registry">registry</a></dd>
                <dd id="Ring.metadata" class="variable"><a href="#Base.metadata">metadata</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Sync">
                            <input id="Sync-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Sync</span><wbr>(<span class="base">sqlalchemy.inspection.Inspectable[sqlalchemy.orm.state.InstanceState[typing.Any]]</span>):

                <label class="view-source-button" for="Sync-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sync"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sync-68"><a href="#Sync-68"><span class="linenos">68</span></a><span class="k">class</span> <span class="nc">Sync</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
</span><span id="Sync-69"><a href="#Sync-69"><span class="linenos">69</span></a>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;syncs&quot;</span>
</span><span id="Sync-70"><a href="#Sync-70"><span class="linenos">70</span></a>    <span class="n">sync_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Sync-71"><a href="#Sync-71"><span class="linenos">71</span></a>    <span class="n">ring_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;rings.ring_id&quot;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Sync-72"><a href="#Sync-72"><span class="linenos">72</span></a>    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">DateTimeInUTC</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Sync-73"><a href="#Sync-73"><span class="linenos">73</span></a>    <span class="n">comment</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Sync-74"><a href="#Sync-74"><span class="linenos">74</span></a>    <span class="n">ring</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="s2">&quot;Ring&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;syncs&quot;</span><span class="p">)</span>
</span><span id="Sync-75"><a href="#Sync-75"><span class="linenos">75</span></a>    <span class="n">heart_rates</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;sync&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Base class used for declarative class definitions.</p>

<p>The <code>_orm.DeclarativeBase</code> allows for the creation of new
declarative bases in such a way that is compatible with type checkers::</p>

<pre><code>from sqlalchemy.orm import DeclarativeBase

class Base(DeclarativeBase):
    pass
</code></pre>

<p>The above <code><a href="#Base">Base</a></code> class is now usable as the base for new declarative
mappings.  The superclass makes use of the <code>__init_subclass__()</code>
method to set up new classes and metaclasses aren't used.</p>

<p>When first used, the <code>_orm.DeclarativeBase</code> class instantiates a new
<code>_orm.registry</code> to be used with the base, assuming one was not
provided explicitly. The <code>_orm.DeclarativeBase</code> class supports
class-level attributes which act as parameters for the construction of this
registry; such as to indicate a specific <code>_schema.MetaData</code>
collection as well as a specific value for
:paramref:<code>_orm.registry.type_annotation_map</code>::</p>

<pre><code>from typing_extensions import Annotated

from sqlalchemy import BigInteger
from sqlalchemy import MetaData
from sqlalchemy import String
from sqlalchemy.orm import DeclarativeBase

bigint = Annotated[int, "bigint"]
my_metadata = MetaData()

class Base(DeclarativeBase):
    metadata = my_metadata
    type_annotation_map = {
        str: String().with_variant(String(255), "mysql", "mariadb"),
        bigint: BigInteger()
    }
</code></pre>

<p>Class-level attributes which may be specified include:</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>metadata</strong>:  optional <code>_schema.MetaData</code> collection.
If a <code>_orm.registry</code> is constructed automatically, this
<code>_schema.MetaData</code> collection will be used to construct it.
Otherwise, the local <code>_schema.MetaData</code> collection will supercede
that used by an existing <code>_orm.registry</code> passed using the
:paramref:<code>_orm.DeclarativeBase.registry</code> parameter.</li>
<li><strong>type_annotation_map</strong>:  optional type annotation map that will be
passed to the <code>_orm.registry</code> as
:paramref:<code>_orm.registry.type_annotation_map</code>.</li>
<li><strong>registry</strong>:  supply a pre-existing <code>_orm.registry</code> directly.</li>
</ul>

<p><em>New in version 2.0  Added <code>.DeclarativeBase</code>, so that declarative:</em>
base classes may be constructed in such a way that is also recognized
by :pep:<code>484</code> type checkers.   As a result, <code>.DeclarativeBase</code>
and other subclassing-oriented APIs should be seen as
superseding previous "class returned by a function" APIs, namely
<code>_orm.declarative_base()</code> and <code>_orm.registry.generate_base()</code>,
where the base class returned cannot be recognized by type checkers
without using plugins.</p>

<p><strong>__init__ behavior</strong></p>

<p>In a plain Python class, the base-most <code><a href="#Sync.__init__">__init__()</a></code> method in the class
hierarchy is <code>object.__init__()</code>, which accepts no arguments. However,
when the <code>_orm.DeclarativeBase</code> subclass is first declared, the
class is given an <code><a href="#Sync.__init__">__init__()</a></code> method that links to the
:paramref:<code>_orm.registry.constructor</code> constructor function, if no
<code><a href="#Sync.__init__">__init__()</a></code> method is already present; this is the usual declarative
constructor that will assign keyword arguments as attributes on the
instance, assuming those attributes are established at the class level
(i.e. are mapped, or are linked to a descriptor). This constructor is
<strong>never accessed by a mapped class without being called explicitly via
super()</strong>, as mapped classes are themselves given an <code><a href="#Sync.__init__">__init__()</a></code> method
directly which calls :paramref:<code>_orm.registry.constructor</code>, so in the
default case works independently of what the base-most <code><a href="#Sync.__init__">__init__()</a></code>
method does.</p>

<p><em>Changed in version 2.0.1  <code>_orm.DeclarativeBase</code> has a default:</em>
constructor that links to :paramref:<code>_orm.registry.constructor</code> by
default, so that calls to <code>super().__init__()</code> can access this
constructor. Previously, due to an implementation mistake, this default
constructor was missing, and calling <code>super().__init__()</code> would invoke
<code>object.__init__()</code>.</p>

<p>The <code>_orm.DeclarativeBase</code> subclass may also declare an explicit
<code><a href="#Sync.__init__">__init__()</a></code> method which will replace the use of the
:paramref:<code>_orm.registry.constructor</code> function at this level::</p>

<pre><code>class Base(DeclarativeBase):
    def __init__(self, id=None):
        self.id = id
</code></pre>

<p>Mapped classes still will not invoke this constructor implicitly; it
remains only accessible by calling <code>super().__init__()</code>::</p>

<pre><code>class MyClass(Base):
    def __init__(self, id=None, name=None):
        self.name = name
        super().__init__(id=id)
</code></pre>

<p>Note that this is a different behavior from what functions like the legacy
<code>_orm.declarative_base()</code> would do; the base created by those functions
would always install :paramref:<code>_orm.registry.constructor</code> for
<code><a href="#Sync.__init__">__init__()</a></code>.</p>
</div>


                            <div id="Sync.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">Sync</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#Sync.__init__"></a>
    
            <div class="docstring"><p>A simple constructor that allows initialization from kwargs.</p>

<p>Sets attributes on the constructed instance using the names and
values in <code>kwargs</code>.</p>

<p>Only keys that are present as
attributes of the instance's class are allowed. These could be,
for example, any mapped columns or relationships.</p>
</div>


                            </div>
                            <div id="Sync.sync_id" class="classattr">
                                <div class="attr variable">
            <span class="name">sync_id</span><span class="annotation">: sqlalchemy.orm.base.Mapped[int]</span>

        
    </div>
    <a class="headerlink" href="#Sync.sync_id"></a>
    
    

                            </div>
                            <div id="Sync.ring_id" class="classattr">
                                <div class="attr variable">
            <span class="name">ring_id</span>

        
    </div>
    <a class="headerlink" href="#Sync.ring_id"></a>
    
    

                            </div>
                            <div id="Sync.timestamp" class="classattr">
                                <div class="attr variable">
            <span class="name">timestamp</span>

        
    </div>
    <a class="headerlink" href="#Sync.timestamp"></a>
    
    

                            </div>
                            <div id="Sync.comment" class="classattr">
                                <div class="attr variable">
            <span class="name">comment</span><span class="annotation">: sqlalchemy.orm.base.Mapped[str | None]</span>

        
    </div>
    <a class="headerlink" href="#Sync.comment"></a>
    
    

                            </div>
                            <div id="Sync.ring" class="classattr">
                                <div class="attr variable">
            <span class="name">ring</span><span class="annotation">: sqlalchemy.orm.base.Mapped[<a href="#Ring">Ring</a>]</span>

        
    </div>
    <a class="headerlink" href="#Sync.ring"></a>
    
    

                            </div>
                            <div id="Sync.heart_rates" class="classattr">
                                <div class="attr variable">
            <span class="name">heart_rates</span><span class="annotation">: sqlalchemy.orm.base.Mapped[list[<a href="#HeartRate">HeartRate</a>]]</span>

        
    </div>
    <a class="headerlink" href="#Sync.heart_rates"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Base">Base</a></dt>
                                <dd id="Sync.registry" class="variable"><a href="#Base.registry">registry</a></dd>
                <dd id="Sync.metadata" class="variable"><a href="#Base.metadata">metadata</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="HeartRate">
                            <input id="HeartRate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">HeartRate</span><wbr>(<span class="base">sqlalchemy.inspection.Inspectable[sqlalchemy.orm.state.InstanceState[typing.Any]]</span>):

                <label class="view-source-button" for="HeartRate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HeartRate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HeartRate-78"><a href="#HeartRate-78"><span class="linenos">78</span></a><span class="k">class</span> <span class="nc">HeartRate</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
</span><span id="HeartRate-79"><a href="#HeartRate-79"><span class="linenos">79</span></a>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;heart_rates&quot;</span>
</span><span id="HeartRate-80"><a href="#HeartRate-80"><span class="linenos">80</span></a>    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span><span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;ring_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">),)</span>
</span><span id="HeartRate-81"><a href="#HeartRate-81"><span class="linenos">81</span></a>    <span class="n">heart_rate_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="HeartRate-82"><a href="#HeartRate-82"><span class="linenos">82</span></a>    <span class="n">reading</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="HeartRate-83"><a href="#HeartRate-83"><span class="linenos">83</span></a>    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">DateTimeInUTC</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="HeartRate-84"><a href="#HeartRate-84"><span class="linenos">84</span></a>    <span class="n">ring_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;rings.ring_id&quot;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="HeartRate-85"><a href="#HeartRate-85"><span class="linenos">85</span></a>    <span class="n">ring</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="s2">&quot;Ring&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;heart_rates&quot;</span><span class="p">)</span>
</span><span id="HeartRate-86"><a href="#HeartRate-86"><span class="linenos">86</span></a>    <span class="n">sync_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;syncs.sync_id&quot;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="HeartRate-87"><a href="#HeartRate-87"><span class="linenos">87</span></a>    <span class="n">sync</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="s2">&quot;Sync&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;heart_rates&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Base class used for declarative class definitions.</p>

<p>The <code>_orm.DeclarativeBase</code> allows for the creation of new
declarative bases in such a way that is compatible with type checkers::</p>

<pre><code>from sqlalchemy.orm import DeclarativeBase

class Base(DeclarativeBase):
    pass
</code></pre>

<p>The above <code><a href="#Base">Base</a></code> class is now usable as the base for new declarative
mappings.  The superclass makes use of the <code>__init_subclass__()</code>
method to set up new classes and metaclasses aren't used.</p>

<p>When first used, the <code>_orm.DeclarativeBase</code> class instantiates a new
<code>_orm.registry</code> to be used with the base, assuming one was not
provided explicitly. The <code>_orm.DeclarativeBase</code> class supports
class-level attributes which act as parameters for the construction of this
registry; such as to indicate a specific <code>_schema.MetaData</code>
collection as well as a specific value for
:paramref:<code>_orm.registry.type_annotation_map</code>::</p>

<pre><code>from typing_extensions import Annotated

from sqlalchemy import BigInteger
from sqlalchemy import MetaData
from sqlalchemy import String
from sqlalchemy.orm import DeclarativeBase

bigint = Annotated[int, "bigint"]
my_metadata = MetaData()

class Base(DeclarativeBase):
    metadata = my_metadata
    type_annotation_map = {
        str: String().with_variant(String(255), "mysql", "mariadb"),
        bigint: BigInteger()
    }
</code></pre>

<p>Class-level attributes which may be specified include:</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>metadata</strong>:  optional <code>_schema.MetaData</code> collection.
If a <code>_orm.registry</code> is constructed automatically, this
<code>_schema.MetaData</code> collection will be used to construct it.
Otherwise, the local <code>_schema.MetaData</code> collection will supercede
that used by an existing <code>_orm.registry</code> passed using the
:paramref:<code>_orm.DeclarativeBase.registry</code> parameter.</li>
<li><strong>type_annotation_map</strong>:  optional type annotation map that will be
passed to the <code>_orm.registry</code> as
:paramref:<code>_orm.registry.type_annotation_map</code>.</li>
<li><strong>registry</strong>:  supply a pre-existing <code>_orm.registry</code> directly.</li>
</ul>

<p><em>New in version 2.0  Added <code>.DeclarativeBase</code>, so that declarative:</em>
base classes may be constructed in such a way that is also recognized
by :pep:<code>484</code> type checkers.   As a result, <code>.DeclarativeBase</code>
and other subclassing-oriented APIs should be seen as
superseding previous "class returned by a function" APIs, namely
<code>_orm.declarative_base()</code> and <code>_orm.registry.generate_base()</code>,
where the base class returned cannot be recognized by type checkers
without using plugins.</p>

<p><strong>__init__ behavior</strong></p>

<p>In a plain Python class, the base-most <code><a href="#HeartRate.__init__">__init__()</a></code> method in the class
hierarchy is <code>object.__init__()</code>, which accepts no arguments. However,
when the <code>_orm.DeclarativeBase</code> subclass is first declared, the
class is given an <code><a href="#HeartRate.__init__">__init__()</a></code> method that links to the
:paramref:<code>_orm.registry.constructor</code> constructor function, if no
<code><a href="#HeartRate.__init__">__init__()</a></code> method is already present; this is the usual declarative
constructor that will assign keyword arguments as attributes on the
instance, assuming those attributes are established at the class level
(i.e. are mapped, or are linked to a descriptor). This constructor is
<strong>never accessed by a mapped class without being called explicitly via
super()</strong>, as mapped classes are themselves given an <code><a href="#HeartRate.__init__">__init__()</a></code> method
directly which calls :paramref:<code>_orm.registry.constructor</code>, so in the
default case works independently of what the base-most <code><a href="#HeartRate.__init__">__init__()</a></code>
method does.</p>

<p><em>Changed in version 2.0.1  <code>_orm.DeclarativeBase</code> has a default:</em>
constructor that links to :paramref:<code>_orm.registry.constructor</code> by
default, so that calls to <code>super().__init__()</code> can access this
constructor. Previously, due to an implementation mistake, this default
constructor was missing, and calling <code>super().__init__()</code> would invoke
<code>object.__init__()</code>.</p>

<p>The <code>_orm.DeclarativeBase</code> subclass may also declare an explicit
<code><a href="#HeartRate.__init__">__init__()</a></code> method which will replace the use of the
:paramref:<code>_orm.registry.constructor</code> function at this level::</p>

<pre><code>class Base(DeclarativeBase):
    def __init__(self, id=None):
        self.id = id
</code></pre>

<p>Mapped classes still will not invoke this constructor implicitly; it
remains only accessible by calling <code>super().__init__()</code>::</p>

<pre><code>class MyClass(Base):
    def __init__(self, id=None, name=None):
        self.name = name
        super().__init__(id=id)
</code></pre>

<p>Note that this is a different behavior from what functions like the legacy
<code>_orm.declarative_base()</code> would do; the base created by those functions
would always install :paramref:<code>_orm.registry.constructor</code> for
<code><a href="#HeartRate.__init__">__init__()</a></code>.</p>
</div>


                            <div id="HeartRate.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">HeartRate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#HeartRate.__init__"></a>
    
            <div class="docstring"><p>A simple constructor that allows initialization from kwargs.</p>

<p>Sets attributes on the constructed instance using the names and
values in <code>kwargs</code>.</p>

<p>Only keys that are present as
attributes of the instance's class are allowed. These could be,
for example, any mapped columns or relationships.</p>
</div>


                            </div>
                            <div id="HeartRate.heart_rate_id" class="classattr">
                                <div class="attr variable">
            <span class="name">heart_rate_id</span><span class="annotation">: sqlalchemy.orm.base.Mapped[int]</span>

        
    </div>
    <a class="headerlink" href="#HeartRate.heart_rate_id"></a>
    
    

                            </div>
                            <div id="HeartRate.reading" class="classattr">
                                <div class="attr variable">
            <span class="name">reading</span><span class="annotation">: sqlalchemy.orm.base.Mapped[int]</span>

        
    </div>
    <a class="headerlink" href="#HeartRate.reading"></a>
    
    

                            </div>
                            <div id="HeartRate.timestamp" class="classattr">
                                <div class="attr variable">
            <span class="name">timestamp</span>

        
    </div>
    <a class="headerlink" href="#HeartRate.timestamp"></a>
    
    

                            </div>
                            <div id="HeartRate.ring_id" class="classattr">
                                <div class="attr variable">
            <span class="name">ring_id</span>

        
    </div>
    <a class="headerlink" href="#HeartRate.ring_id"></a>
    
    

                            </div>
                            <div id="HeartRate.ring" class="classattr">
                                <div class="attr variable">
            <span class="name">ring</span><span class="annotation">: sqlalchemy.orm.base.Mapped[<a href="#Ring">Ring</a>]</span>

        
    </div>
    <a class="headerlink" href="#HeartRate.ring"></a>
    
    

                            </div>
                            <div id="HeartRate.sync_id" class="classattr">
                                <div class="attr variable">
            <span class="name">sync_id</span>

        
    </div>
    <a class="headerlink" href="#HeartRate.sync_id"></a>
    
    

                            </div>
                            <div id="HeartRate.sync" class="classattr">
                                <div class="attr variable">
            <span class="name">sync</span><span class="annotation">: sqlalchemy.orm.base.Mapped[<a href="#Sync">Sync</a>]</span>

        
    </div>
    <a class="headerlink" href="#HeartRate.sync"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Base">Base</a></dt>
                                <dd id="HeartRate.registry" class="variable"><a href="#Base.registry">registry</a></dd>
                <dd id="HeartRate.metadata" class="variable"><a href="#Base.metadata">metadata</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="set_sqlite_pragma">
                            <input id="set_sqlite_pragma-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@event.listens_for(Engine, &#39;connect&#39;)</div>

        <span class="def">def</span>
        <span class="name">set_sqlite_pragma</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">dbapi_connection</span><span class="p">:</span> <span class="n">Any</span>, </span><span class="param"><span class="n">_connection_record</span><span class="p">:</span> <span class="n">Any</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="set_sqlite_pragma-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#set_sqlite_pragma"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="set_sqlite_pragma-90"><a href="#set_sqlite_pragma-90"><span class="linenos">90</span></a><span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Engine</span><span class="p">,</span> <span class="s2">&quot;connect&quot;</span><span class="p">)</span>
</span><span id="set_sqlite_pragma-91"><a href="#set_sqlite_pragma-91"><span class="linenos">91</span></a><span class="k">def</span> <span class="nf">set_sqlite_pragma</span><span class="p">(</span><span class="n">dbapi_connection</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">_connection_record</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="set_sqlite_pragma-92"><a href="#set_sqlite_pragma-92"><span class="linenos">92</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Enable actual foreign key checks in sqlite on every connection to the database&quot;&quot;&quot;</span>
</span><span id="set_sqlite_pragma-93"><a href="#set_sqlite_pragma-93"><span class="linenos">93</span></a>
</span><span id="set_sqlite_pragma-94"><a href="#set_sqlite_pragma-94"><span class="linenos">94</span></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="n">dbapi_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span id="set_sqlite_pragma-95"><a href="#set_sqlite_pragma-95"><span class="linenos">95</span></a>    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys=ON&quot;</span><span class="p">)</span>
</span><span id="set_sqlite_pragma-96"><a href="#set_sqlite_pragma-96"><span class="linenos">96</span></a>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Enable actual foreign key checks in sqlite on every connection to the database</p>
</div>


                </section>
                <section id="get_db_session">
                            <input id="get_db_session-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_db_session</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">path</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span>:</span></span>

                <label class="view-source-button" for="get_db_session-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_db_session"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_db_session-99"><a href="#get_db_session-99"><span class="linenos"> 99</span></a><span class="k">def</span> <span class="nf">get_db_session</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Session</span><span class="p">:</span>
</span><span id="get_db_session-100"><a href="#get_db_session-100"><span class="linenos">100</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_db_session-101"><a href="#get_db_session-101"><span class="linenos">101</span></a><span class="sd">    Return a live db session with all tables created.</span>
</span><span id="get_db_session-102"><a href="#get_db_session-102"><span class="linenos">102</span></a>
</span><span id="get_db_session-103"><a href="#get_db_session-103"><span class="linenos">103</span></a><span class="sd">    TODO: probably not default to in memory... that&#39;s just useful for testing</span>
</span><span id="get_db_session-104"><a href="#get_db_session-104"><span class="linenos">104</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_db_session-105"><a href="#get_db_session-105"><span class="linenos">105</span></a>
</span><span id="get_db_session-106"><a href="#get_db_session-106"><span class="linenos">106</span></a>    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;sqlite:///&quot;</span>
</span><span id="get_db_session-107"><a href="#get_db_session-107"><span class="linenos">107</span></a>    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="get_db_session-108"><a href="#get_db_session-108"><span class="linenos">108</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="get_db_session-109"><a href="#get_db_session-109"><span class="linenos">109</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="get_db_session-110"><a href="#get_db_session-110"><span class="linenos">110</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using in memory sqlite database. Data will be lost after program exits&quot;</span><span class="p">)</span>
</span><span id="get_db_session-111"><a href="#get_db_session-111"><span class="linenos">111</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;:memory:&quot;</span>
</span><span id="get_db_session-112"><a href="#get_db_session-112"><span class="linenos">112</span></a>    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="get_db_session-113"><a href="#get_db_session-113"><span class="linenos">113</span></a>    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
</span><span id="get_db_session-114"><a href="#get_db_session-114"><span class="linenos">114</span></a>    <span class="k">return</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Return a live db session with all tables created.</p>

<p>TODO: probably not default to in memory... that's just useful for testing</p>
</div>


                </section>
                <section id="create_or_find_ring">
                            <input id="create_or_find_ring-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_or_find_ring</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span>,</span><span class="param">	<span class="n">address</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n"><a href="#Ring">Ring</a></span>:</span></span>

                <label class="view-source-button" for="create_or_find_ring-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_or_find_ring"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_or_find_ring-117"><a href="#create_or_find_ring-117"><span class="linenos">117</span></a><span class="k">def</span> <span class="nf">create_or_find_ring</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Ring</span><span class="p">:</span>
</span><span id="create_or_find_ring-118"><a href="#create_or_find_ring-118"><span class="linenos">118</span></a>    <span class="n">ring</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">Ring</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Ring</span><span class="o">.</span><span class="n">address</span> <span class="o">==</span> <span class="n">address</span><span class="p">))</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>
</span><span id="create_or_find_ring-119"><a href="#create_or_find_ring-119"><span class="linenos">119</span></a>    <span class="k">if</span> <span class="n">ring</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="create_or_find_ring-120"><a href="#create_or_find_ring-120"><span class="linenos">120</span></a>        <span class="k">return</span> <span class="n">ring</span>
</span><span id="create_or_find_ring-121"><a href="#create_or_find_ring-121"><span class="linenos">121</span></a>
</span><span id="create_or_find_ring-122"><a href="#create_or_find_ring-122"><span class="linenos">122</span></a>    <span class="n">ring</span> <span class="o">=</span> <span class="n">Ring</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">)</span>
</span><span id="create_or_find_ring-123"><a href="#create_or_find_ring-123"><span class="linenos">123</span></a>    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
</span><span id="create_or_find_ring-124"><a href="#create_or_find_ring-124"><span class="linenos">124</span></a>    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># not sure this should be here tbh</span>
</span><span id="create_or_find_ring-125"><a href="#create_or_find_ring-125"><span class="linenos">125</span></a>    <span class="k">return</span> <span class="n">ring</span>
</span></pre></div>


    

                </section>
                <section id="sync">
                            <input id="sync-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sync</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span>,</span><span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n"><a href="client.html#FullData">colmi_r02_client.client.FullData</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="sync-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#sync"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="sync-128"><a href="#sync-128"><span class="linenos">128</span></a><span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">FullData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="sync-129"><a href="#sync-129"><span class="linenos">129</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="sync-130"><a href="#sync-130"><span class="linenos">130</span></a><span class="sd">    TODO:</span>
</span><span id="sync-131"><a href="#sync-131"><span class="linenos">131</span></a><span class="sd">        - grab battery</span>
</span><span id="sync-132"><a href="#sync-132"><span class="linenos">132</span></a><span class="sd">        - grab steps</span>
</span><span id="sync-133"><a href="#sync-133"><span class="linenos">133</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="sync-134"><a href="#sync-134"><span class="linenos">134</span></a>
</span><span id="sync-135"><a href="#sync-135"><span class="linenos">135</span></a>    <span class="n">ring</span> <span class="o">=</span> <span class="n">create_or_find_ring</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
</span><span id="sync-136"><a href="#sync-136"><span class="linenos">136</span></a>    <span class="n">sync</span> <span class="o">=</span> <span class="n">Sync</span><span class="p">(</span><span class="n">ring</span><span class="o">=</span><span class="n">ring</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">))</span>
</span><span id="sync-137"><a href="#sync-137"><span class="linenos">137</span></a>    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sync</span><span class="p">)</span>
</span><span id="sync-138"><a href="#sync-138"><span class="linenos">138</span></a>
</span><span id="sync-139"><a href="#sync-139"><span class="linenos">139</span></a>    <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">heart_rates</span><span class="p">:</span>
</span><span id="sync-140"><a href="#sync-140"><span class="linenos">140</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">hr</span><span class="o">.</span><span class="n">NoData</span><span class="p">):</span>
</span><span id="sync-141"><a href="#sync-141"><span class="linenos">141</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No heart rate data for date&quot;</span><span class="p">)</span>
</span><span id="sync-142"><a href="#sync-142"><span class="linenos">142</span></a>            <span class="k">continue</span>
</span><span id="sync-143"><a href="#sync-143"><span class="linenos">143</span></a>
</span><span id="sync-144"><a href="#sync-144"><span class="linenos">144</span></a>        <span class="n">existing</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="sync-145"><a href="#sync-145"><span class="linenos">145</span></a>        <span class="k">for</span> <span class="n">heart_rate</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
</span><span id="sync-146"><a href="#sync-146"><span class="linenos">146</span></a>            <span class="n">select</span><span class="p">(</span><span class="n">HeartRate</span><span class="p">)</span>
</span><span id="sync-147"><a href="#sync-147"><span class="linenos">147</span></a>            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">HeartRate</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;=</span> <span class="n">start_of_day</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">timestamp</span><span class="p">))</span>
</span><span id="sync-148"><a href="#sync-148"><span class="linenos">148</span></a>            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">HeartRate</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&lt;=</span> <span class="n">end_of_day</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">timestamp</span><span class="p">))</span>
</span><span id="sync-149"><a href="#sync-149"><span class="linenos">149</span></a>        <span class="p">):</span>
</span><span id="sync-150"><a href="#sync-150"><span class="linenos">150</span></a>            <span class="n">existing</span><span class="p">[</span><span class="n">heart_rate</span><span class="o">.</span><span class="n">timestamp</span><span class="p">]</span> <span class="o">=</span> <span class="n">heart_rate</span><span class="o">.</span><span class="n">reading</span>
</span><span id="sync-151"><a href="#sync-151"><span class="linenos">151</span></a>
</span><span id="sync-152"><a href="#sync-152"><span class="linenos">152</span></a>        <span class="k">for</span> <span class="n">reading</span><span class="p">,</span> <span class="n">timestamp</span> <span class="ow">in</span> <span class="n">log</span><span class="o">.</span><span class="n">heart_rates_with_times</span><span class="p">():</span>
</span><span id="sync-153"><a href="#sync-153"><span class="linenos">153</span></a>            <span class="k">if</span> <span class="n">reading</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="sync-154"><a href="#sync-154"><span class="linenos">154</span></a>                <span class="k">continue</span>
</span><span id="sync-155"><a href="#sync-155"><span class="linenos">155</span></a>
</span><span id="sync-156"><a href="#sync-156"><span class="linenos">156</span></a>            <span class="k">if</span> <span class="n">x</span> <span class="o">:=</span> <span class="n">existing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
</span><span id="sync-157"><a href="#sync-157"><span class="linenos">157</span></a>                <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">reading</span><span class="p">:</span>
</span><span id="sync-158"><a href="#sync-158"><span class="linenos">158</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inconsistent data detected! </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> in db but got </span><span class="si">{</span><span class="n">reading</span><span class="si">}</span><span class="s2"> from ring&quot;</span><span class="p">)</span>
</span><span id="sync-159"><a href="#sync-159"><span class="linenos">159</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="sync-160"><a href="#sync-160"><span class="linenos">160</span></a>                <span class="n">h</span> <span class="o">=</span> <span class="n">HeartRate</span><span class="p">(</span><span class="n">reading</span><span class="o">=</span><span class="n">reading</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">ring</span><span class="o">=</span><span class="n">ring</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="n">sync</span><span class="p">)</span>
</span><span id="sync-161"><a href="#sync-161"><span class="linenos">161</span></a>                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</span><span id="sync-162"><a href="#sync-162"><span class="linenos">162</span></a>
</span><span id="sync-163"><a href="#sync-163"><span class="linenos">163</span></a>    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>TODO:
    - grab battery
    - grab steps</p>
</div>


                </section>
                <section id="get_last_sync">
                            <input id="get_last_sync-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_last_sync</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">session</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span></span><span class="return-annotation">) -> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="get_last_sync-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_last_sync"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_last_sync-166"><a href="#get_last_sync-166"><span class="linenos">166</span></a><span class="k">def</span> <span class="nf">get_last_sync</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="get_last_sync-167"><a href="#get_last_sync-167"><span class="linenos">167</span></a>    <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Sync</span><span class="o">.</span><span class="n">timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>
</span></pre></div>


    

                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>